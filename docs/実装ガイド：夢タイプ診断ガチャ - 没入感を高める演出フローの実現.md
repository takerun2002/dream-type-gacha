# 実装ガイド：夢タイプ診断ガチャ - 没入感を高める演出フローの実現

## 1. はじめに

本ドキュメントは、Next.js（App Router）とFramer Motionを用いて、「夢タイプ診断ガチャ」のユーザー体験を向上させるための、リッチな3段階演出フローの実装方法を包括的に解説するものです。診断完了からカード登場までの一連の流れをシームレスに繋ぎ、ユーザーの期待感を最大限に高めることを目的とします。

**演出フローの概要:**

1.  **共通演出（約8秒）**: きんまんキャラクターと水晶玉による、診断の導入を告げる動画。
2.  **タイプ別演出（約8秒）**: 診断結果に応じて、9種類の動物キャラクターが登場する動画。
3.  **カード登場演出（約2秒）**: 3D回転、エフェクトを伴い、最終的な診断カードがダイナミックに出現。

本ガイドでは、動画生成の推奨アプローチ、Framer Motionによる具体的なアニメーション実装、そして動画再生とAPI通信を並行処理する高度なフロー制御について、詳細なコード例と共に解説します。

## 2. 動画コンテンツの生成（ElevenLabs & AI Video Platforms）

演出の核となる動画コンテンツは、ElevenLabsの音声合成とAIビデオ生成プラットフォームを組み合わせることで、高品質かつ効率的に制作可能です。

### 2.1. 推奨アプローチ：HeyGen + ElevenLabs

**HeyGen** は、アップロードしたキャラクターイラストを元に、自然なリップシンクを持つアバター動画を生成できるプラットフォームです。ElevenLabsの高品質なボイスクローンと組み合わせることで、きんまんキャラクターが実際に話しているかのような動画を制作できます。

**制作フロー:**

1.  **音声の準備**: ElevenLabsできんまん先生のボイスクローンを使用し、「あなたの運命を占いましょう...」などのナレーション音声を生成・ダウンロードします。
2.  **アバターの準備**: きんまんキャラクターのイラスト（立ちポーズ、座禅ポーズなど）を準備します。
3.  **動画生成 (HeyGen)**: HeyGenにログインし、きんまんのイラストをアバターとしてアップロード。準備したナレーション音声を適用し、水晶玉が輝くなどの視覚エフェクトを追加して、MP4動画を生成します。
4.  **タイプ別動画**: 9種類の動物についても同様に、それぞれに対応するイラストと短い演出（例：炎の中から現れる不死鳥）を組み合わせた動画を生成します。

### 2.2. 動画ファイルの管理

生成した動画ファイルは、Next.jsプロジェクトの`public`ディレクトリに配置して、静的アセットとして配信します。

```
/public
└── videos
    ├── common-fortune-telling.mp4  # 共通演出
    ├── phoenix-reveal.mp4          # 鳳凰タイプ
    ├── dragon-reveal.mp4           # 龍タイプ
    └── ... (他7タイプ)
```

**最適化のポイント**: 動画ファイルはVercelのEdge Networkによって効率的にキャッシュ・配信されますが、ファイルサイズを5〜15MB程度に圧縮（FFmpegなどを利用）することで、初回読み込み時間を短縮できます。

## 3. 演出フローの全体設計と並行処理

本演出の鍵は、ユーザーを待たせることなく、動画再生の裏側でカード生成APIの呼び出しを完了させる**並行処理**にあります。

### 3.1. フローのシーケンス

ユーザー体験は以下の3つのステージで構成され、`useState`と`useEffect`を用いて状態を管理します。

| ステージ | 期間 | ユーザーが見る画面 | バックグラウンド処理 |
| :--- | :--- | :--- | :--- |
| **1. 共通演出** | 8秒 | きんまんの占い動画 | なし |
| **2. タイプ別演出** | 8秒 | 結果に対応する動物動画 | **カード生成APIを非同期で呼び出し** |
| **3. カード登場** | 2秒 | 生成されたカードが登場するアニメーション | なし |

### 3.2. 並行処理の実装

ステージ2（タイプ別演出）の開始と同時に、`useEffect`内でカード生成API (`/api/generate-card`) を`fetch`します。このAPI呼び出しは非同期で行われるため、ユーザーは動画再生を楽しみながら待つことができます。APIからのレスポンス（生成されたカードの画像データ）は`useState`に保存され、ステージ3への遷移トリガーとなります。

詳細は添付の`framer_motion_components.tsx`内の`DiagnosisFlow`コンポーネントをご参照ください。このコンポーネントが全体のフロー制御を担います。

## 4. Framer Motionによるカード登場アニメーション

カード登場シーンは、複数のアニメーションを組み合わせることで、リッチで満足度の高い体験を創出します。`Framer Motion`の優れた宣言的APIにより、これを直感的に実装できます。

### 4.1. 実装するエフェクト

-   **3D回転**: カードが裏面から表面へ回転しながら登場 (`rotateY: 180` → `0`)。
-   **スケールアップ**: 小さな点から画面いっぱいに拡大 (`scale: 0.3` → `1.0`)。
-   **ゴールドの光のオーラ**: カードの背後に広がる柔らかな光の輪。
-   **キラキラパーティクル**: カードの周囲を漂う光の粒子が、期待感を増幅させます。

### 4.2. コードの構造

これらのエフェクトは、それぞれ独立したReactコンポーネントとして作成し、`CardReveal`コンポーネント内で組み合わせています。これにより、各アニメーションのタイミングやスタイルを個別に調整しやすくなります。

> **`CardReveal`コンポーネントの構造**
> - `motion.div` (ゴールドオーラ背景)
> - `motion.div` (カード本体：3D回転とスケールアップ)
> - `ParticleEffect` (パーティクルコンポーネント)
> - `SparkleEffect` (キラキラエフェクトコンポーネント)

具体的なアニメーションの`initial`, `animate`, `transition`の各プロパティ設定については、添付の`framer_motion_components.tsx`をご参照ください。

## 5. 成果物一覧

本調査・設計に基づき、以下の成果物を作成しました。これらをプロジェクトに組み込むことで、本ガイドで解説した演出フローを実装できます。

1.  **dream_type_animation_guide.md (本ファイル)**
    実装の全体像と各技術要素の設計思想を解説する、最上位のガイドドキュメントです。

2.  **framer_motion_components.tsx**
    演出フロー全体を管理する`DiagnosisFlow`コンポーネントと、各ステージ（`CommonRevealStage`, `TypeSpecificStage`, `CardReveal`）のアニメーションを実装した、コピー＆ペースト可能なReactコンポーネントファイルです。

3.  **animation_flow_diagram.md**
    時間軸に沿ったシーケンス、コンポーネント間の関係、API呼び出しのタイミングを視覚的に表現したフロー図です。実装時の全体像の把握に役立ちます。

## 6. 結論

ご提案の演出フローは、AIビデオ生成、リッチなフロントエンドアニメーション、そしてバックグラウンドでの非同期処理という、モダンなWeb技術を組み合わせることで実現可能です。本ガイドと添付のコードを基に実装を進めることで、ユーザーに驚きと満足感を与える、高品質な診断体験を提供できると確信しております。
