# 夢タイプ診断ガチャ - 演出フロー図

## 全体フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    ユーザー診断開始                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│          ステージ1: 共通演出（8秒）                          │
│    ・きんまん + 水晶玉の動画を再生                            │
│    ・背景グロー、テキストオーバーレイ                        │
│    ・ビデオ: /videos/common-fortune-telling.mp4            │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌──────────────────────┐  ┌──────────────────────┐
│  ステージ2開始        │  │ バックグラウンド     │
│  タイプ別演出再生     │  │ カード生成API呼び出し│
│  （8秒）             │  │ 処理中...            │
└──────────────────────┘  └──────────────────────┘
        │                         │
        │  ┌─────────────────────┘
        │  │
        ▼  ▼
┌─────────────────────────────────────────────────────────────┐
│          ステージ2: タイプ別演出（8秒）                      │
│    ・診断結果に応じた動物キャラクターの動画                  │
│    ・背景エフェクト（ゴールドリング）                        │
│    ・ビデオ: /videos/{dreamType}-reveal.mp4               │
│    ・同時進行: カード生成処理                                │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌──────────────────────┐  ┌──────────────────────┐
│  ステージ3開始        │  │ カード生成完了       │
│  カード登場演出       │  │ 画像バッファ準備完了 │
└──────────────────────┘  └──────────────────────┘
        │                         │
        │  ┌─────────────────────┘
        │  │
        ▼  ▼
┌─────────────────────────────────────────────────────────────┐
│          ステージ3: カード登場（2秒）                        │
│    ・カード: rotateY: 180° → 0°                             │
│    ・スケール: 0.3 → 1.0                                    │
│    ・パーティクルエフェクト: 40個の粒子が放射状に拡散        │
│    ・キラキラエフェクト: 16個の光が周囲を回転               │
│    ・ゴールドオーラ背景                                      │
│    ・カード光沢エフェクト                                    │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                   診断完了                                    │
│            ユーザーがカードを確認                            │
└─────────────────────────────────────────────────────────────┘
```

## 並行処理フロー（詳細）

```
時間軸 →

0秒
├─ ステージ1開始
│  └─ 共通演出ビデオ再生開始
│     └─ background glow animation
│     └─ text overlay animation
│
8秒
├─ ステージ1終了 / ステージ2開始
├─ タイプ別演出ビデオ再生開始
├─ 【バックグラウンド】カード生成API呼び出し
│  ├─ POST /api/generate-card
│  ├─ Satori: JSX → SVG変換
│  ├─ Sharp: SVG → PNG変換
│  └─ 画像バッファ準備完了（通常3〜5秒以内）
│
16秒
├─ ステージ2終了 / ステージ3開始
├─ カード登場アニメーション開始
│  ├─ rotateY animation (0.9秒)
│  ├─ scale animation (0.9秒)
│  ├─ particle effect (1.2秒)
│  ├─ sparkle effect (2秒, repeat)
│  └─ glow background animation (1.2秒)
│
18秒
└─ 演出完了 / ユーザーにカード表示
```

## ステージ別詳細

### ステージ1: 共通演出

```
┌─────────────────────────────────────────┐
│         Common Reveal Stage              │
├─────────────────────────────────────────┤
│                                          │
│  ┌──────────────────────────────────┐  │
│  │  Background Glow (Infinite Loop)  │  │
│  │  opacity: [0.3, 0.6, 0.3]        │  │
│  │  duration: 3s                     │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │  Video Container                  │  │
│  │  ┌────────────────────────────┐  │  │
│  │  │  Video Player              │  │  │
│  │  │  src: common-fortune...mp4 │  │  │
│  │  │  autoPlay, muted           │  │  │
│  │  └────────────────────────────┘  │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │  Text Overlay (delay: 1s)        │  │
│  │  "あなたの運命を占いましょう..."  │  │
│  └──────────────────────────────────┘  │
│                                          │
└─────────────────────────────────────────┘
```

### ステージ2: タイプ別演出

```
┌─────────────────────────────────────────┐
│      Type-Specific Reveal Stage          │
├─────────────────────────────────────────┤
│                                          │
│  ┌──────────────────────────────────┐  │
│  │  Background Glow (Infinite Loop)  │  │
│  │  boxShadow: [                     │  │
│  │    '0 0 20px rgba(...)',          │  │
│  │    '0 0 40px rgba(...)',          │  │
│  │    '0 0 20px rgba(...)'           │  │
│  │  ]                                │  │
│  │  duration: 2s                     │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │  Video Container                  │  │
│  │  ┌────────────────────────────┐  │  │
│  │  │  Video Player              │  │  │
│  │  │  src: {dreamType}-reveal.mp4│ │  │
│  │  │  autoPlay, muted           │  │  │
│  │  └────────────────────────────┘  │  │
│  └──────────────────────────────────┘  │
│                                          │
│  【バックグラウンド】                    │
│  カード生成処理: 3〜5秒                 │
│                                          │
└─────────────────────────────────────────┘
```

### ステージ3: カード登場

```
┌─────────────────────────────────────────────────────────────┐
│              Card Reveal Stage                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│              ┌─────────────────────┐                         │
│              │  Sparkle Effect     │                         │
│              │  (16 particles)     │                         │
│              │  Infinite Loop      │                         │
│              └─────────────────────┘                         │
│                      ▲                                        │
│                      │                                        │
│         ┌────────────┼────────────┐                          │
│         │            │            │                          │
│    ┌────▼───┐  ┌─────▼──┐  ┌────▼───┐                      │
│    │Glow    │  │  Card  │  │Particle│                      │
│    │Aura    │  │ (Main) │  │Effect  │                      │
│    │(Bg)    │  │        │  │(40)    │                      │
│    └────────┘  └────────┘  └────────┘                      │
│                                                              │
│    Animation Details:                                        │
│    ┌─────────────────────────────────────────────────────┐ │
│    │ Glow Aura:                                          │ │
│    │ - initial: scale 0, opacity 0                       │ │
│    │ - animate: scale 1, opacity 0.6                     │ │
│    │ - duration: 1.2s                                    │ │
│    │                                                     │ │
│    │ Card:                                               │ │
│    │ - initial: rotateY 180°, scale 0.3, opacity 0      │ │
│    │ - animate: rotateY 0°, scale 1, opacity 1          │ │
│    │ - duration: 0.9s                                    │ │
│    │ - type: spring (stiffness: 100, damping: 15)       │ │
│    │                                                     │ │
│    │ Particles:                                          │ │
│    │ - 40 particles in radial pattern                    │ │
│    │ - duration: 1.2s + random(0.4s)                    │ │
│    │ - spread: 200-300px radius                         │ │
│    │                                                     │ │
│    │ Sparkles:                                           │ │
│    │ - 16 particles in circular orbit                    │ │
│    │ - duration: 2s                                      │ │
│    │ - repeat: Infinity                                  │ │
│    └─────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## タイプ別演出マッピング

```
診断結果 → ビデオファイル

phoenix      → /videos/phoenix-reveal.mp4       (🔥 鳳凰)
kitsune      → /videos/kitsune-reveal.mp4       (🦊 狐)
pegasus      → /videos/pegasus-reveal.mp4       (🐴 ペガサス)
elephant     → /videos/elephant-reveal.mp4      (🐘 象)
deer         → /videos/deer-reveal.mp4          (🦌 鹿)
dragon       → /videos/dragon-reveal.mp4        (🐉 龍)
turtle       → /videos/turtle-reveal.mp4        (🐢 亀)
shark        → /videos/shark-reveal.mp4         (🦈 鯱)
wolf         → /videos/wolf-reveal.mp4          (🐺 狼)
```

## API呼び出しタイミング

```
ステージ2開始時点
    ↓
fetch('/api/generate-card', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    dreamType: 'phoenix',
    typeName: '情熱の不死鳥タイプ',
    message: 'あなたは情熱的で...',
    icon: '🔥'
  })
})
    ↓
【バックグラウンド処理】
    ├─ Satori: JSX → SVG (1〜2秒)
    ├─ Sharp: SVG → PNG (1〜2秒)
    └─ 画像バッファ準備完了 (3〜5秒以内)
    ↓
ステージ3開始時点
    ↓
cardImage が存在 → CardReveal コンポーネント表示
```

## エラーハンドリングフロー

```
API呼び出し
    ↓
┌─ 成功 ─→ 画像バッファ取得 ─→ ステージ3で表示
│
└─ 失敗 ─→ フォールバック画像使用
            (/images/fallback-card.png)
            ↓
            ステージ3で表示
            ↓
            コンソールにエラーログ出力
```

## パフォーマンス最適化ポイント

```
【ビデオ最適化】
- 形式: MP4 (H.264)
- 解像度: 1080p
- フレームレート: 30fps
- ファイルサイズ: 5〜20MB
- 圧縮: FFmpeg推奨

【アニメーション最適化】
- GPU加速: will-change: transform
- フレームレート: 60fps
- 不要なDOM操作を削減
- 複雑なエフェクトは制限

【API最適化】
- タイムアウト: 10秒（Pro版は60秒）
- キャッシング: 1時間
- 画像品質: 85%
- 非同期処理: Promise.all()

【ネットワーク最適化】
- ビデオプリロード: lazy
- 画像遅延読み込み: 実装
- CDN配信: Vercel自動
```
